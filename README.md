# FoodOS

A full‚Äëstack food platform that unifies **recipes**, **inventory & groceries**, **meal planning**, **restaurants**, and a BeReal‚Äëstyle social feature called **Rate My Plate** ‚Äî plus **camera‚Äëbased recipe capture (OCR)** and **AI‚Äëassisted recipe generation & search**.

> **Audience:** Written like a senior dev spec with enough nuance for a junior dev to ramp up and contribute.
>
> **Status:** Planning ‚Üí MVP execution.
>
> **Last updated:** 2025-08-28

---

## Table of Contents

1. [Project Origin & Initial Prompts](#project-origin--initial-prompts)
2. [Vision & Goals](#vision--goals)
3. [Feature Overview](#feature-overview)
4. [System Architecture](#system-architecture)
5. [Tech Stack](#tech-stack)
6. [Existing Assets to Reuse](#existing-assets-to-reuse)
7. [Data Model](#data-model)
8. [API Design (v0)](#api-design-v0)
9. [ML/AI Components](#mlai-components)
10. [Security, Privacy, and Abuse Prevention](#security-privacy-and-abuse-prevention)
11. [Networking, Scaling & Performance](#networking-scaling--performance)
12. [Testing Strategy](#testing-strategy)
13. [Developer Experience & Repo Layout](#developer-experience--repo-layout)
14. [Local Dev: Getting Started](#local-dev-getting-started)
15. [Roadmap & Milestones](#roadmap--milestones)
16. [Open Questions / Decisions Needed](#open-questions--decisions-needed)
17. [Contributing](#contributing)
18. [License](#license)

---

## Project Origin & Initial Prompts

- Build an "everything in one" food app: **restaurants + recipes + inventory + meal planning**.
- Add a **BeReal‚Äëlike daily photo** feature called **Rate My Plate** where users must post their plate once per day to participate.
- **Reuse an existing Foods app** (CLI + Tkinter + MySQL schema) as the core data layer and business logic.
- Add **camera‚Äëbased recipe capture** (OCR of cookbooks, screenshots, labels) to auto‚Äëcreate structured recipes.
- Incorporate **AI** to generate recipes, substitutions, and **semantic search** across recipes and dishes.

This README lays out an implementable plan that grows from an MVP to a robust, scalable platform.

---

## Vision & Goals

**Vision:** FoodOS is a personal and social food operating system. It supports cooking at home, discovering restaurants, planning meals, keeping inventory, and sharing daily eating habits ‚Äî with AI and OCR to minimize data entry and maximize discovery.

**Primary goals**
- **Unify workflows:** single app for planning, cooking, tracking, going out, and sharing.
- **Minimize friction:** OCR and AI turn photos/text into structured recipes and grocery actions.
- **Make it social:** Rate My Plate drives daily engagement and accountability.
- **Be extensible:** clean APIs, job workers, and modular services for future features.

**Non-goals (for now)**
- Calorie estimation from raw images (hard to do well without a sizable dataset). We‚Äôll bootstrap via user tags + recipe mapping and consider computer vision later.
- Professional nutrition/medical advice.

---

## Feature Overview

### Recipes
- Browse/sort by name, category, cooking time, calories.
- **AI recipe generator** (prompt ‚Üí JSON ‚Üí DB insert).
- **OCR import**: capture from camera/photo; parse into ingredients + steps.
- **Semantic search** (‚Äúrecipes like this‚Äù) via embeddings.
- Versioning for edited recipes (future).

### Inventory & Grocery
- Track items by location (fridge/freezer/pantry).
- Bulk updates; auto‚Äëdecrement when a meal is cooked.
- Generate **grocery lists** from recipes/meal plans.
- Optional store hints/tags (e.g., Costco/Trader Joe‚Äôs).

### Meal Planning
- Weekly calendar; attach recipes.
- Export CSV or shareable link.
- Macro/nutrient totals (computed from ingredients).

### Restaurants
- Nearby search via public APIs (Yelp/Places). Cache responses.
- Save favorites, tag dishes, link to ‚Äúhome recipe equivalents.‚Äù
- (Stretch) Turn a restaurant dish into an at‚Äëhome recipe suggestion.

### Social: Rate My Plate
- Daily posting window per user (configurable). One post/day enforced.
- Feed with friends‚Äô posts; 1‚Äì5 ratings; comments.
- Streaks & gentle reminders (notifications/web push).
- Privacy: default to friends‚Äëonly; toggle per post.

### Camera Capture (OCR)
- Upload/Take photo; extract text with OCR.
- Parse quantities/units/ingredients ‚Üí structured recipe.
- Map unknown ingredients to canonical set (fuzzy/embedding match).

---

## System Architecture

```
[ Web App (Next.js PWA) ]  <‚Äî OAuth/JWT ‚Äî>  [ API Gateway (FastAPI) ]
          ‚îÇ                                     ‚îÇ
          ‚îÇ                                     ‚îú‚îÄ‚îÄ /recipes, /inventory, /mealplan, /grocery  ‚Üí  SQL (MySQL‚ÜíPostgres later)
          ‚îÇ                                     ‚îú‚îÄ‚îÄ /restaurants  ‚Üí Public API proxy + cache
          ‚îÇ                                     ‚îú‚îÄ‚îÄ /rate-my-plate ‚Üí S3/MinIO for images + DB
          ‚îÇ                                     ‚îú‚îÄ‚îÄ /import/ocr    ‚Üí enqueue OCR jobs
          ‚îÇ                                     ‚îî‚îÄ‚îÄ /ai            ‚Üí recipe-gen, embeddings, search
          ‚îÇ
          ‚îî‚îÄ‚îÄ WebSockets (feed/live updates)     [ Workers (Celery/RQ) ]
                                                  ‚îú‚îÄ‚îÄ OCR ‚Üí parse ‚Üí insert recipe
                                                  ‚îú‚îÄ‚îÄ Embeddings ‚Üí vector index
                                                  ‚îî‚îÄ‚îÄ ETL & maintenance jobs

[ Data Layer ]
- SQL DB: start with MySQL (reuse); consider Postgres + pgvector
- Object storage: S3/MinIO for uploads (images, exports)
- Cache/Queue: Redis (sessions, rate limits, queues)
- Observability: Prometheus + Grafana; Loki for logs (opt)
```

**Why FastAPI + Next.js?** Clear typing (Pydantic), good developer speed, Python ML ecosystem, great DX on the web side, easy WebSocket support, and incremental SSR/ISR.

---

## Tech Stack

- **Frontend:** Next.js, React, Tailwind, shadcn/ui, React Query. PWA for camera upload.
- **Backend:** FastAPI (Python 3.11+), Pydantic v2, SQLAlchemy, Alembic.
- **Workers:** Celery or RQ with Redis.
- **DB:** MySQL 8 (existing) ‚Üí optional migration to Postgres 15 + pgvector.
- **Search/Vector:** FAISS or pgvector for embeddings.
- **OCR:** Tesseract (MVP), consider PaddleOCR for messy receipts.
- **Object Storage:** MinIO/S3 with signed URLs.
- **Auth:** OAuth (Auth.js/Clerk) ‚Üí JWT to API.
- **CI/CD:** GitHub Actions (lint, tests, migrations). Docker Compose for dev.
- **Secrets:** .env files locally; managed secrets in production.

---

## Existing Assets to Reuse

- **MySQL schema + seed**: `Ingredient`, `Inventory`, `Recipe`, `RecipeIngredient`, `MealPlan`, `GroceryList`, `MealPlanView`.
- **CLI (main.py)**: working CRUD flows; CSV export; AI recipe generation (remove hardcoded API key; use env).
- **Tkinter UI (mainwfront.py)**: validates queries/flows; useful reference for first web screens.
- **meal_plan_report.csv**: export format we‚Äôll reproduce in web.

Reusing this logic lets us deliver a credible MVP fast, then refactor incrementally.

---

## Data Model

### Existing Tables
- **Ingredient(IngredientID, name, description, cal, protein, fat, carb)**
- **Inventory(InventoryID, IngredientID, quantity, location)**
- **Recipe(RecipeID, name, instructions, cookTimeMin, servings, category)**
- **RecipeIngredient(RecipeIngredientID, IngredientID, RecipeID, quantity, unitMeasure)**
- **MealPlan(MealPlanID, MealDate, RecipeID)**
- **GroceryList(GroceryListID, RecipeIngredientID, store)**
- **MealPlanView** (view of recipes by date)

### New Tables (FoodOS)
- **User(user_id, handle, email, created_at, privacy_settings json)**
- **PlatePost(post_id, user_id, ts, image_url, caption, dish_tags json, posted_window_date, visibility)**
- **PlateRating(post_id, rater_user_id, score, comment, ts)**
- **Restaurant(rest_id, name, address, lat, lon, cuisines json, price_tier, source, source_id)**
- **UserRestaurant(user_id, rest_id, favorite, rating, last_visit_at)**
- **RecipeImport(import_id, user_id, ts, image_url, ocr_text, parse_json, status enum)**
- **RecipeEmbedding(recipe_id, embedding(vector))** (pgvector/FAISS)
- **UserPref(user_id, diet_flags json, allergies json, budget_level int)**

**Notes**
- Keep IDs stable and explicit (no ORM surprises in ingestion).
- Use `json/jsonb` columns for flexible metadata; normalize later if needed.
- Add FK indexes early; we‚Äôll need them for feeds and joins.

---

## API Design (v0)

**Auth**
- `POST /auth/callback` (handled by OAuth provider) ‚Üí issues JWT for API usage.

**Recipes**
- `GET /recipes?search=text&category=&maxTime=&calBand=`
- `GET /recipes/{id}`
- `POST /recipes` (manual add)
- `POST /recipes/import` ‚Üí returns `import_id`; worker performs OCR ‚Üí parse ‚Üí insert
- `GET /recipes/similar/{id}` (embedding search)
- `POST /ai/recipe-generate` (server‚Äëside key; returns JSON and optional DB insert)

**Inventory & Grocery**
- `GET /inventory?location=`
- `PATCH /inventory/{ingredientId}` ‚Üí `{{ "quantity": 2 }}`
- `POST /grocery/from-recipe/{id}`

**Meal Plan**
- `GET /mealplan?week=YYYY-WW`
- `POST /mealplan` ‚Üí add items
- `GET /mealplan/export.csv`

**Restaurants**
- `GET /restaurants/nearby?lat=&lon=&q=` (proxy + cache)
- `POST /restaurants/save` (fav/rating)

**Rate My Plate**
- `POST /plate` (enforce 1/day; signed URL upload then finalize metadata)
- `GET /plate/feed?cursor=`
- `POST /plate/{id}/rate` `{{ "score": 4, "comment": "üî•" }}`

**WebSockets**
- `/ws/feed` ‚Üí push new posts/ratings/comments to subscribers.

**Error Model**
- JSON problem details RFC7807; consistent error codes; rate‚Äëlimit headers on relevant endpoints.

---

## ML/AI Components

1. **OCR ‚Üí Parser ‚Üí Recipe**
   - Pipeline: upload ‚Üí OCR (Tesseract) ‚Üí text blocks ‚Üí unit/quantity parser ‚Üí canonical ingredient mapping ‚Üí DB insert.
   - Unknown ingredients: heuristic + embedding nearest‚Äëneighbor; if still unknown, create placeholder with review flag.

2. **Recipe Generation**
   - Prompted generation for constraints (diet, time, budget). Always parse to strict JSON schema. Manual review toggle before insert.

3. **Embeddings for Search & ‚ÄúSimilar‚Äù**
   - Offline job to embed recipe titles + instructions.
   - Cosine similarity for related recipes; use MMR for diverse results.

4. **Nutrition Aggregation**
   - Compute macros from `RecipeIngredient √ó Ingredient` at query‚Äëtime, cache aggregates in a materialized view for top recipes.

---

## Security, Privacy, and Abuse Prevention

- **Secrets**: Never ship hardcoded API keys. Use env vars; limit scope with per‚Äëservice tokens.
- **Auth**: OAuth for user auth; short‚Äëlived JWT for API; rotate keys.
- **Access control**: Friends‚Äëonly default for Rate My Plate; private posts supported.
- **Uploads**: Validate MIME, size limits, content scanning (ClamAV container), signed URLs, object lifecycle policies.
- **Rate limiting**: Per IP + per user. Redis sliding window.
- **Abuse**: Basic image/text moderation hooks (queue suspicious posts for review).
- **PII**: Store only necessary fields; encrypt at rest where appropriate.
- **Audit logs**: For sensitive actions (deletes, privacy changes).

---

## Networking, Scaling & Performance

- **Caching**: Redis for hot recipe queries and restaurant lookups.
- **Pagination**: Cursor‚Äëbased for feeds and long lists.
- **Backpressure**: Queue ingestion (OCR/AI) via workers; retry with dead‚Äëletter queues.
- **N+1**: Use `JOIN` + prefetch patterns in API; measure query plans.
- **Static/ISR**: Next.js for semi‚Äëstatic content (docs, about).
- **Observability**: Request IDs, structured logs, RED metrics dashboards.

---

## Testing Strategy

- **Unit**: Pure functions (parsers, mappers, calorie calculators).
- **API Integration**: FastAPI TestClient with ephemeral DB (Docker).
- **Workers**: Task‚Äëlevel tests with fake queues & fixtures.
- **E2E**: Playwright (web flows: login ‚Üí post plate ‚Üí rate ‚Üí feed).
- **Data**: Seed datasets for deterministic tests; snapshot expected CSV exports.
- **Security**: Static analysis (bandit), dependency checks (pip‚Äëaudit).

---

## Developer Experience & Repo Layout

```
foodos/
‚îú‚îÄ apps/
‚îÇ  ‚îî‚îÄ web/                 # Next.js PWA
‚îú‚îÄ services/
‚îÇ  ‚îî‚îÄ api/                 # FastAPI app (REST + WS)
‚îú‚îÄ workers/
‚îÇ  ‚îú‚îÄ ocr/                 # OCR + parsing pipeline
‚îÇ  ‚îî‚îÄ ai/                  # embeddings, recipe-gen jobs
‚îú‚îÄ packages/
‚îÇ  ‚îî‚îÄ shared/              # shared types, DTOs, schema
‚îú‚îÄ infra/
‚îÇ  ‚îú‚îÄ docker-compose.yml   # dev stack (db, redis, minio, api, web, workers)
‚îÇ  ‚îî‚îÄ migrations/          # Alembic or SQL files
‚îú‚îÄ db/
‚îÇ  ‚îú‚îÄ init/                # initial schema, seeds
‚îÇ  ‚îî‚îÄ views/               # materialized views, helpful SQL
‚îú‚îÄ docs/
‚îÇ  ‚îî‚îÄ ADRs/                # architecture decisions
‚îî‚îÄ README.md               # this file
```

**Conventions**
- Python: ruff/black; TypeScript: eslint/prettier.
- Commits: Conventional Commits (`feat:`, `fix:`‚Ä¶). PR templates enforced.

---

## Local Dev: Getting Started

1. **Prereqs**
   - Docker + Docker Compose, Node 20+, Python 3.11+, Make.

2. **Clone & Boot Dev Stack**
   ```bash
   git clone <repo> foodos && cd foodos
   cp .env.example .env  # fill in values
   docker compose -f infra/docker-compose.yml up -d
   ```

3. **Database**
   - For MVP, import the existing MySQL dump:
     ```bash
     mysql -h 127.0.0.1 -u root -p < db/init/data-dump.sql
     ```

4. **API**
   ```bash
   cd services/api
   pip install -r requirements.txt
   uvicorn app.main:app --reload
   ```

5. **Web**
   ```bash
   cd apps/web
   npm i
   npm run dev
   ```

6. **Workers**
   ```bash
   cd workers/ocr && pip install -r requirements.txt
   celery -A worker.app worker -l INFO
   ```

7. **Secrets**
   - Store API keys in `.env` and inject only server‚Äëside. **Never** commit keys.

---

## Roadmap & Milestones

### Phase 1 ‚Äî Foundation (Weeks 1‚Äì2)
- [ ] Bring up Docker Compose (DB, Redis, MinIO, API, Web).
- [ ] Import existing schema/seed; verify legacy queries.
- [ ] Wrap existing queries as FastAPI endpoints:
  - [ ] `/recipes`, `/inventory`, `/mealplan`, `/grocery`
- [ ] Web screens: Recipes list/detail, Meal Plan, Inventory.
- [ ] Replace hardcoded AI key with env; server‚Äëside recipe‚Äëgen.

### Phase 2 ‚Äî Social & OCR (Weeks 3‚Äì5)
- [ ] *Rate My Plate*: tables, upload flow (signed URLs), feed.
- [ ] Enforce one post/day; comments/ratings; WebSocket feed.
- [ ] OCR ingestion: `/recipes/import` ‚Üí worker ‚Üí parse ‚Üí insert.
- [ ] Ingredient canonicalization; review UI for unknowns.

### Phase 3 ‚Äî Restaurants & Search (Weeks 6‚Äì7)
- [ ] Restaurant API proxy + caching; save favorites & ratings.
- [ ] Embeddings + semantic search; ‚Äúsimilar recipes/dishes‚Äù.

### Phase 4 ‚Äî Polish & Scale (Weeks 8+)
- [ ] Auth (OAuth, JWT), user settings/privacy.
- [ ] Notifications (daily plate window, reminders).
- [ ] Analytics: nutrient totals, grocery spend estimates.
- [ ] Optional: migrate to Postgres + pgvector; Helm charts for k8s.

**Stretch Ideas**
- Household sharing (shared inventory/grocery).
- Basic CV dish classifier; map to nearest recipe.
- Social graph growth tools (discover friends, weekly highlights).

---

## Open Questions / Decisions Needed

- **DB**: stay on MySQL for MVP or migrate early to Postgres + pgvector?
- **OCR**: Tesseract vs PaddleOCR ‚Äî which performs better on our samples?
- **Mobile**: PWA vs React Native from day one?
- **Privacy defaults**: friends‚Äëonly posts by default?
- **Moderation**: proactive (models) vs reactive (report/queue)?
- **Restaurant APIs**: which provider & terms are acceptable for caching?

---

## Contributing

- Open a draft PR early; use task lists in PR descriptions.
- Add/Update ADRs for notable architectural decisions.
- Add tests for new endpoints and workers.
- Keep docs current (this README + `/docs`).

---

## License

TBD (e.g., MIT for code). Review third‚Äëparty API ToS before redistribution of their data.

